CREATE OR REPLACE PROCEDURE USER1.INSERT_FOODITEMLIST(IN_MENUID IN NUMBER, IN_FOODITEMID IN NUMBER, IN_QUANTITY IN NUMBER) IS

    V_MENUNAME       MENU.MENUNAME%TYPE;
    V_MENUDESC       MENU.MENUDESC%TYPE;
    V_QUANTITY       FOODITEMLIST.QUANTITY%TYPE;
    V_FOODITEMNAME   FOODITEM.FOODITEMNAME%TYPE;
    E_INVALIDINPUT   EXCEPTION;
    
    CURSOR MENU_FOODITEM_CURSOR IS
        SELECT FI.FOODITEMNAME, FIL.QUANTITY
        FROM MENU M, FOODITEMLIST FIL, FOODITEM FI
        WHERE M.MENUID = FIL.MENUID 
          AND FI.FOODITEMID = FIL.FOODITEMID 
          AND M.MENUID = IN_MENUID;
BEGIN

    -- CHECK IF IT IS NUMBER
    IF (IN_QUANTITY <= 0 OR IN_QUANTITY > 50) THEN
        RAISE E_INVALIDINPUT;
    END IF;

    SELECT MENUNAME  , MENUDESC 
    INTO   V_MENUNAME, V_MENUDESC
    FROM   MENU M
    WHERE  M.MENUID = IN_MENUID;

    DBMS_OUTPUT.PUT_LINE ('Menu Name : ' || V_MENUNAME);
    DBMS_OUTPUT.PUT_LINE ('Menu Description : ' || V_MENUDESC);
    DBMS_OUTPUT.PUT_LINE (CHR(10));

    DBMS_OUTPUT.PUT_LINE ('Current Menu Food List : ');

    OPEN MENU_FOODITEM_CURSOR;
    LOOP
        FETCH MENU_FOODITEM_CURSOR INTO V_FOODITEMNAME, V_QUANTITY;
        EXIT WHEN MENU_FOODITEM_CURSOR%NOTFOUND;

        DBMS_OUTPUT.PUT_LINE (MENU_FOODITEM_CURSOR%ROWCOUNT || '. ' || V_FOODITEMNAME || '* ' || V_QUANTITY);

    END LOOP;
    CLOSE MENU_FOODITEM_CURSOR;

    -- RUN INSERT ;
    INSERT INTO FOODITEMLIST VALUES(IN_MENUID, IN_FOODITEMID, IN_QUANTITY);

    DBMS_OUTPUT.PUT_LINE (CHR(10));
    DBMS_OUTPUT.PUT_LINE ('Food List has been successfuly added to the menu: ');
    DBMS_OUTPUT.PUT_LINE (CHR(10));

    DBMS_OUTPUT.PUT_LINE ('Updated Menu Food List : ');

    OPEN MENU_FOODITEM_CURSOR;
    LOOP
        FETCH MENU_FOODITEM_CURSOR INTO V_FOODITEMNAME, V_QUANTITY;
        EXIT WHEN MENU_FOODITEM_CURSOR%NOTFOUND;

        DBMS_OUTPUT.PUT_LINE (MENU_FOODITEM_CURSOR%ROWCOUNT || '. ' || V_FOODITEMNAME || ' * ' || V_QUANTITY);

    END LOOP;
    CLOSE MENU_FOODITEM_CURSOR;

    DBMS_OUTPUT.PUT_LINE (CHR(10));

EXCEPTION
    WHEN E_INVALIDINPUT THEN
        DBMS_OUTPUT.PUT_LINE('Invalid Input: Quantity cannot be less than 1 or more than 50.');
        RAISE_APPLICATION_ERROR(-20003, 'Invalid Input: Quantity cannot be less than 1 or more than 50.');

    WHEN DUP_VAL_ON_INDEX THEN
        DBMS_OUTPUT.PUT_LINE('You have tried to insert a same food item.');
        RAISE_APPLICATION_ERROR(-20001,'You have tried to insert a same food item.');

    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('No records found for the food item or the menu.');
        RAISE_APPLICATION_ERROR(-20002,'No records found for the food item or the menu.');

    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('An error has occurred when inserting the menu category. Please contact administrator.');
        RAISE_APPLICATION_ERROR(-20003,'An error has occurred when inserting the menu category. Please contact administrator');

END;
/

-- 1. DISPLAY BEFORE
SELECT FI.FOODITEMNAME, FIL.QUANTITY
FROM MENU M, FOODITEMLIST FIL , FOODITEM FI 
WHERE M.MENUID = FIL.MENUID AND
    FI.FOODITEMID = FIL.FOODITEMID AND
    M.MENUID = 1001;

-- 2. INSERT
EXEC INSERT_FOODITEMLIST(1001, 1002, 11);

-- 3. DISPLAY AFTER
SELECT FI.FOODITEMNAME, FIL.QUANTITY
FROM MENU M, FOODITEMLIST FIL , FOODITEM FI 
WHERE M.MENUID = FIL.MENUID AND
    FI.FOODITEMID = FIL.FOODITEMID AND
    M.MENUID = 1001;

-- 4. RESET
DELETE FROM FOODITEMLIST
WHERE   MENUID = 1001 AND
        FOODITEMID = 1002;
