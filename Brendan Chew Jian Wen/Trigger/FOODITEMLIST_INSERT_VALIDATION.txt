DROP TRIGGER FOODITEMLIST_INSERT_VALIDATION;

CREATE OR REPLACE TRIGGER FOODITEMLIST_INSERT_VALIDATION
    BEFORE 
    INSERT
    ON FOODITEMLIST
    FOR EACH ROW    
DECLARE
    V_MENUID             MENU.MENUID%TYPE;
    V_NO_OF_FOODITEM     INTEGER;
    E_TOOMANY_FOODITEM   EXCEPTION;
       
BEGIN
    SELECT M.MENUID, COUNT(FIL.FOODITEMID) NO_OF_FIL
    INTO V_MENUID, V_NO_OF_FOODITEM
    FROM MENU M, FOODITEMLIST FIL, FOODITEM FI
    WHERE M.MENUID = FIL.MENUID AND
          FI.FOODITEMID = FIL.FOODITEMID AND
          M.MENUID = :NEW.MENUID
    GROUP BY M.MENUID;

    IF V_NO_OF_FOODITEM = 10 THEN
        RAISE E_TOOMANY_FOODITEM;
    END IF;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20001, 'Fooditem cannot be insert: Either menu or fooditem not found.');
    WHEN E_TOOMANY_FOODITEM THEN
        RAISE_APPLICATION_ERROR(-20002, 'There are too many fooditem for this menu already. You cannot add more than 10 fooditem for the menu.');
END;
/

-- TEST TRIGGER
INSERT INTO FOODITEMLIST VALUES (1000, 1002, 2);
INSERT INTO FOODITEMLIST VALUES (1001, 1000, 2);

INSERT INTO FOODITEMLIST VALUES (1001, 1002, 2);
INSERT INTO FOODITEMLIST VALUES (1001, 1003, 3);
INSERT INTO FOODITEMLIST VALUES (1001, 1004, 4);
INSERT INTO FOODITEMLIST VALUES (1001, 1005, 5);
INSERT INTO FOODITEMLIST VALUES (1001, 1006, 6);
INSERT INTO FOODITEMLIST VALUES (1001, 1007, 7);
INSERT INTO FOODITEMLIST VALUES (1001, 1008, 8);
INSERT INTO FOODITEMLIST VALUES (1001, 1009, 9);
INSERT INTO FOODITEMLIST VALUES (1001, 1010, 10);

-- This sould fail
INSERT INTO FOODITEMLIST VALUES (1001, 1011, 11);

DELETE FROM FOODITEMLIST WHERE MENUID = 1001 AND FOODITEMID = 1002;
DELETE FROM FOODITEMLIST WHERE MENUID = 1001 AND FOODITEMID = 1003;
DELETE FROM FOODITEMLIST WHERE MENUID = 1001 AND FOODITEMID = 1004;
DELETE FROM FOODITEMLIST WHERE MENUID = 1001 AND FOODITEMID = 1005;
DELETE FROM FOODITEMLIST WHERE MENUID = 1001 AND FOODITEMID = 1006;
DELETE FROM FOODITEMLIST WHERE MENUID = 1001 AND FOODITEMID = 1007;
DELETE FROM FOODITEMLIST WHERE MENUID = 1001 AND FOODITEMID = 1008;
DELETE FROM FOODITEMLIST WHERE MENUID = 1001 AND FOODITEMID = 1009;
DELETE FROM FOODITEMLIST WHERE MENUID = 1001 AND FOODITEMID = 1010;

-- This sould have 0 rows returned
DELETE FROM FOODITEMLIST WHERE MENUID = 1001 AND FOODITEMID = 1011;

